<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" name="File Browsing" content="简单的本地文件浏览器" http-equiv="refresh" content="30">
    <meta http-equiv="Expirse" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">

	<base href="http://192.168.31.111:8089">
	<link rel="shortcut icon" href="/img/title.png">
	<title>File Browsing</title>
	<link href="css/metro.min.css" rel="stylesheet" media="screen">
	<link href="css/index.css" rel="stylesheet" type="text/css">
	<script src="js/jquery.min.js"></script>
	<script src="js/metro.min.js"></script>
	<script src="js/lazeload.js"></script>
	<script src="js/util.js"></script>
</head>

<body style="background-color:bisque;">
	<h1 id="file-title" style="margin: 20px auto 20px 20px;">
		<a>
			<img alt="收藏" id="star" src="img/unstar.png" style="cursor: pointer;" onclick="javascript:dir_start();">
		</a>
	</h1>
	<h2 style="margin: 20px auto 20px 20px;">
		<a style="text-decoration:none" href="favorite.html"> 收藏的网址 </a>
    </h2>

	<div id="menu" style="margin: 1% auto auto 1%;font-size:20px;background-color:rgb(251, 238, 177);height:auto;width:auto;float:left;">
		<p>菜单</p>
		<a id="file_menu">文件模式</a><br><br>
		<a id="pic_menu">图片模式</a><br><br>
		<a id="video_menu">视频模式</a><br><br>
		<a id="music_menu">音乐模式</a><br><br>
		<a id="cartoon_menu">漫画模式</a><br><br>
	</div>
	
	<div class="picinfo" id = "picinfo" style="display:none;">
		<input id = "page_input" oninput="value=value.replace(/[^\d]/g,'')" onkeydown="if(event.keyCode==13) {page_select()}">
		<b></b><b>/0</b>
	</div>
	<br><br>
	<div class="comic_wraCon autoHeight" style="width: 1371px;" id="center_box"">
		<a id = "pre_evt" class="img_land_prev" onclick="prev_img()"></a>
		<a id = "nxt_evt" class="img_land_next" onclick="next_img()"></a>
	</div>
	
	<div style="margin: 1% auto auto 7%;width:auto;background-color:rgb(231, 184, 43)" id="dir_contex">
	<p> 目录</p>
	<ul class="listview list-type-tiles"  id='dir_list'> </ul>
	</div>

	<div style="margin: 1% auto auto 7%;width:auto; background-color:rgb(253, 225, 141)" id="file_contex">
	<p> 文件</p>
	<ul class="listview list-type-tiles"  id='file_list'>  </ul>
	</div>

	<div id="back_gf" style="margin: 1% auto auto 2%">
		<hr>
		<img src="img/back.gif" alt="Smiley face"> 
	</div>

</body>

<script>
var show_list = new Array();
var cur_page = 0;
var is_show_pic = 0;
var browsing_mode = 0; /*0:文件模式; 1:漫画模式; 2:视频模式; 3:音乐模式*/
var golbol_volume = 1;
var is_star = 0

function dir_start() {
	var file_dir = getQueryString('file_dir');
	if (file_dir == null) {
        file_dir = "/"
    }
	var request_url = new String();
	var host = window.location.host;
	if (is_star == 0) {
		request_url = 'http://' + host + '/set_favorite_list?file_dir=' + file_dir;
		$.getJSON(request_url, function(data) {
			if (data["code"] != 0) {
				alert("收藏失败");
				return;
			}
			
			is_star = 1;
			$("#star").attr("src","img/star.png");
			alert("收藏成功")
		});
	} else  {
		request_url = 'http://' + host + '/del_favorite_list?file_dir=' + file_dir;
		$.getJSON(request_url, function(data) {
			if (data["code"] != 0) {
				alert("取消收藏失败");
				return;
			}
			
			is_star = 0;
			$("#star").attr("src","img/unstar.png");
			alert("取消收藏成功")
		});
	}
 }

function shwo_cur_pic(page) {
	var file_dir = getQueryString('file_dir');
	var pic_info = '<b style="margin: 20px auto auto auto";>' + (cur_page+1) + "/" + show_list.length + "<br>" + show_list[page] + "</b>"
	$("#picinfo").find("b").remove();
	$("#picinfo").append(pic_info);

	input = document.getElementById("page_input")
	input.value = page + 1

	if (browsing_mode == 1) {
		var imgStr = '<img style="width: 90%;" src="./img/loading.png" lazy-src="store/' + file_dir + "/" + show_list[page] + '">';
		$("#center_box").find("img").remove();
		$("#center_box").append(imgStr);
		new LazyLoad().init();
	} else if (browsing_mode == 2) {
		myVid=document.getElementById("video1");
		if (myVid) {
			golbol_volume = myVid.volume;
		}
		var vidstr = '<video id = "video1" controls style="width: 75%;"> <source src="store/' + file_dir + "/" + show_list[page] + '" type="video/mp4"> </video>';
		$("#center_box").find("video").remove();
		$("#pre_evt").attr("style","height:50%;");//remove();
		$("#nxt_evt").attr("style","height:50%;");//remove();

		$("#center_box").append(vidstr);
		myVid=document.getElementById("video1");
		myVid.volume=golbol_volume;
		myVid.focus()
		//alert(myVid.volume)
		//$("#center_box").find("video").volume=0.2
	}
	javascript:scroll(0,0);
}

function start_show()
{
	//$("#shwo_pic").attr["style"].append("display:none;");
	//$("#dir_contex").attr("style","display:none;");
	//$("#file_contex").attr("style","display:none;");
	$("#back_gf").attr("style","display:none;");

	$("#center_box").attr("style","display:;");
	$("#picinfo").attr("style","display:;")
	is_show_pic = 1;
	shwo_cur_pic(cur_page);
}

function jump_chapter(dirct) {
	var file_dir = getQueryString('file_dir');
	var browsing_mode = getQueryString('browsing_mode');
	if (!browsing_mode) {
		browsing_mode = 0;
	}
	var request_url = new String();
	var host = window.location.host;
	if (dirct == 0) {
		request_url = 'http://' + host + '/get_prev_dir?file_dir=' + file_dir;
	} else {
		request_url = 'http://' + host + '/get_next_dir?file_dir=' + file_dir;
	}
	$.getJSON(request_url, function(data) {
		if (data["code"] != 0) {
			alert("寻找上、下级目录错误");
			return;
		}
		location.href = "index.html?file_dir=" + data["find_dir"] + "&browsing_mode=" + browsing_mode;
	});
}

function prev_img(obj) {
	if (cur_page == 0) {
		if(confirm("已经是此章节第1页了，要打开上一个章节吗？")==true){
			jump_chapter(0);
		}
		return;
	} else {
		cur_page -= 1;
	}
	shwo_cur_pic(cur_page);
}

function next_img(obj) {
	if (cur_page == (show_list.length - 1)) {
		if(confirm("已经是此章节最后一页了，要打开下一个章节吗？")==true){
			jump_chapter(1);
		}
		return;
	} else {
		cur_page += 1;
	}
	shwo_cur_pic(cur_page);
}

$(document).keydown(function(event){
	if (is_show_pic == 0 || browsing_mode != 1) {
		return;
	}
	if (event.keyCode == 37 /*←*/) {
		prev_img(null);
	} else if (event.keyCode == 39 /*→*/) {
		next_img(null);
	}
});

function page_select() {
	input = document.getElementById("page_input")
	var page = input.value
	if (is_show_pic != 0 && cur_page != page) {
		if (page <= 0 && page >= show_list.length) {
			return;
		}
		cur_page = parseInt(page) - 1;
		shwo_cur_pic(cur_page);
	}
}

function add_title_link(title, browsing_mode) {
	/*为标题添加各级目录链接*/
	var list = $('#file-title');
	var dir_link =  title .split("/");
	var pre_dir = new String();
	var home_dir = 1;

	dir_link.forEach(function(data) {
		var url = new String();
		if (home_dir == 1) {
			url = "/index.html"
			home_dir = 0;
		} else {
			if (data == "/") {
				url.length = 0;
			} else {
				pre_dir = pre_dir + data;
				url = "index.html?file_dir=/" + pre_dir + "&browsing_mode=" + browsing_mode;
				pre_dir = pre_dir + "/";
			}
		}
		if (url.length != 0) {
			list.append('<a  style="text-decoration:none" href="' + url + '">' + data + '/</style="text-decoration:none">')
		}
	});
}

function add_menu_url(title_string, browsing_mode) {
	var url = "index.html?file_dir=" + title_string;

	$('#file_menu').attr("href",url + "&browsing_mode=0");
	$('#pic_menu').attr("href",url + "&browsing_mode=1");
	$('#video_menu').attr("href",url + "&browsing_mode=2");
	$('#music_menu').attr("href",url + "&browsing_mode=3");
	$('#cartoon_menu').attr("href",url + "&browsing_mode=1");
	if (browsing_mode == 0) {
		$("#file_menu").attr("style","background-color:rgb(173, 173, 172);");
	} else if (browsing_mode == 1) {
		$("#pic_menu").attr("style","background-color:rgb(173, 173, 172);");
	} else if (browsing_mode == 2) {
		$("#video_menu").attr("style","background-color:rgb(173, 173, 172);");
	} else if (browsing_mode == 3) {
		$("#music_menu").attr("style","background-color:rgb(173, 173, 172);");
	} else if (browsing_mode == 3) {
		$("#cartoon_menu").attr("style","background-color:rgb(173, 173, 172);");
	}
}

$(function() {
	var file_dir = getQueryString('file_dir');
	if (file_dir == null) {
		file_dir = "";
	} else {
		//file_dir = file_dir.slice(2, file_dir.length-1)
	}
	browsing_mode = getQueryString('browsing_mode');
	if (browsing_mode == null) {
		browsing_mode = 0;
	}
	add_menu_url(file_dir, browsing_mode);
	var title_string = "home" + file_dir;
	add_title_link(title_string, browsing_mode);
	
	//$('#file-title').html(dir_path);
	var host = window.location.host;
	$.getJSON('http://' + host + '/get_file_list?file_dir=' + file_dir + "&browsing_mode=" + browsing_mode, function(data) {
		if (data['code'] != 0 &&  data['code'] != 1) {
		    $('#wrong-content').text(JSON.stringify(data));
            metroDialog.open('#dialog');
            return;
		}
		is_star = data['is_star']
		if (is_star == 1) {
			$("#star").attr("src","img/star.png");
		}
		/*目录显示，一直都在*/
		var file_list = data['dir_list'];
		if (file_list.length != 0) {
			var list = $('#dir_list');
			file_list.forEach(function(data) {
				list.append('<li class="list bg-grayLight"><a href="index.html?file_dir=' + file_dir + '/' + data + '&browsing_mode=' + browsing_mode + '" ><span class="list-title">' + data + '/</span></a></li>')
			});
		} else {
			$("#dir_contex").remove()
		}

		show_list = data['file_list'];
		if (show_list.length != 0) {
			if (browsing_mode != 0) {
				start_show();
			}
			list = $('#file_list');
			show_list.forEach(function(data) {
				list.append('<li class="list bg-grayLight"><a href="store/' + file_dir + '/' + data + '" ><span class="list-title">' + data + '</span></a></li>')
			});
		} else {
			$("#file_contex").remove()
		}
		//var s = len.toString();
		//alert(s); //将输出 String
	});

});

</script>
</html>
